<div class="anime-detail-container">
    {{#if this.backdropUrl}}
    <div class="anime-backdrop-wrapper">
        <div class="anime-backdrop-image" style={{html-safe (concat "background-image: url(" this.backdropUrl ")" )}}>
        </div>
        <div class="anime-backdrop-overlay"></div>
    </div>
    {{/if}}

    <div id="anime-detail-header" class="anime-detail-header">
        <div class="anime-detail-image">
            <img src={{or this.model.images.jpg.large_image_url
                this.model.images.jpg.image_url "/plugins/anime-plugin-ex/images/no-image.png" }} alt={{or
                this.model.title "Anime Poster" }} />
        </div>
        <div class="anime-detail-info">
            <h1>{{or this.model.title "Loading..."}}</h1>
            <div class="anime-rating {{this.scoreColorClass}}">
                <span class="score-circle">
                    <span class="value">{{or this.model.score "N/A"}}</span>
                </span>
                <span class="label">User Score</span>
            </div>
            <div class="anime-meta">
                <p><strong>Type:</strong> {{or this.model.type "N/A"}}</p>
                <p><strong>Status:</strong> {{or this.model.status "N/A"}}</p>
                {{#unless this.isMovie}}
                <p><strong>Episodes:</strong> {{or this.model.episodes "N/A"}}</p>
                {{/unless}}
                <p><strong>Aired:</strong> {{or this.model.aired.string "N/A"}}</p>
            </div>
            <div class="anime-genres">
                {{#each this.model.genres as |genre|}}
                <span class="genre-tag">{{genre.name}}</span>
                {{/each}}
            </div>

            {{#if this.currentUser}}
            <div class="anime-watchlist-actions">
                <div class="watchlist-controls">
                    <select class="watchlist-status-select" {{on "change" this.changeStatus}}>
                        <option value="plan_to_watch" selected={{eq (or this.selectedStatus
                            this.watchlistStatus) "plan_to_watch" }}>Plan to Watch</option>
                        <option value="watching" selected={{eq (or this.selectedStatus this.watchlistStatus) "watching"
                            }}>Watching</option>
                        <option value="completed" selected={{eq (or this.selectedStatus
                            this.watchlistStatus) "completed" }}>Completed</option>
                        <option value="on_hold" selected={{eq (or this.selectedStatus this.watchlistStatus) "on_hold"
                            }}>On Hold</option>
                        <option value="dropped" selected={{eq (or this.selectedStatus this.watchlistStatus) "dropped"
                            }}>Dropped</option>
                    </select>

                    <button type="button"
                        class="btn btn-primary add-to-watchlist-btn {{if this.saving 'is-saving'}} {{if this.addedToWatchlist 'is-success'}}"
                        {{on "click" this.saveToWatchlist}} disabled={{or this.saving (not (or this.selectedStatus
                        this.watchlistStatus))}}>
                        {{#if this.saving}}
                        {{d-icon "spinner" class="fa-spin"}} Saving...
                        {{else if this.addedToWatchlist}}
                        {{d-icon "check"}} Added!
                        {{else}}
                        {{#if this.watchlistStatus}}
                        {{d-icon "rotate"}} Update
                        {{else}}
                        {{d-icon "plus"}} Add to Watchlist
                        {{/if}}
                        {{/if}}
                    </button>
                </div>

                {{#if this.watchlistStatus}}
                <div class="current-status-info">
                    <span class="label">Current Status:</span>
                    <span class="current-status-badge {{this.watchlistStatus}}">
                        {{this.displayWatchlistStatus}}
                    </span>
                </div>
                {{/if}}
            </div>
            {{/if}}
        </div>
    </div>

    {{!-- Quick Jump Navigation (Mobile) --}}
    <nav class="anime-quick-nav">
        {{#if this.model.trailer.embed_url}}
        <button type="button" class="quick-nav-btn" {{on "click" (fn this.scrollToSection "anime-trailer-section" )}}>
            {{d-icon "play"}} Trailer
        </button>
        {{/if}}
        <button type="button" class="quick-nav-btn" {{on "click" (fn this.scrollToSection "anime-episodes-section" )}}>
            {{d-icon "film"}} {{if this.isMovie "Medien" "Episoden"}}
        </button>
        {{#if this.model.anilist.characters}}
        <button type="button" class="quick-nav-btn" {{on "click" (fn this.scrollToSection "anime-characters-section"
            )}}>
            {{d-icon "users"}} Charaktere
        </button>
        {{/if}}
        <button type="button" class="quick-nav-btn" {{on "click" (fn this.scrollToSection "anime-discussion-section"
            )}}>
            {{d-icon "comments"}} Diskussion
        </button>
    </nav>

    <div class="anime-synopsis {{unless this.synopsisExpanded 'collapsed'}}">
        <h2>Synopsis</h2>
        <p class="synopsis-text">{{{this.model.synopsis}}}</p>
        <button type="button" class="btn-expand-synopsis" {{on "click" this.toggleSynopsis}}>
            {{#if this.synopsisExpanded}}
            {{d-icon "chevron-up"}} Weniger anzeigen
            {{else}}
            {{d-icon "chevron-down"}} Mehr lesen
            {{/if}}
        </button>
    </div>

    {{#if (or this.model.anilist.streamingEpisodes.length this.model.anilist.external_links.length)}}
    <div class="anime-streaming-section">
        <h2>{{d-icon "play-circle"}} Watch Online</h2>
        <div class="streaming-links-grid">
            {{#each this.model.anilist.streamingEpisodes as |stream|}}
            <a href={{stream.url}} target="_blank" rel="noopener" class="streaming-link-card">
                {{#if stream.thumbnail}}
                <img src={{stream.thumbnail}} alt={{stream.site}} class="stream-thumb" />
                {{else}}
                <div class="stream-placeholder">{{d-icon "play"}}</div>
                {{/if}}
                <div class="stream-info">
                    <span class="stream-site">{{stream.site}}</span>
                    <span class="stream-title">{{stream.title}}</span>
                </div>
            </a>
            {{/each}}

            {{#each this.model.anilist.external_links as |link|}}
            {{#if (or (eq link.site "Netflix") (eq link.site "Crunchyroll") (eq link.site "Hulu") (eq link.site "Disney
            Plus") (eq link.site "Amazon"))}}
            <a href={{link.url}} target="_blank" rel="noopener" class="streaming-link-card external-provider">
                <div class="stream-info">
                    <span class="stream-site">{{d-icon "external-link-alt"}} {{link.site}}</span>
                    <span class="stream-title">Full Series</span>
                </div>
            </a>
            {{/if}}
            {{/each}}
        </div>
    </div>
    {{/if}}


    {{#if this.isYoutubeTrailer}}
    <div id="anime-trailer-section" class="anime-trailer">
        <h2>Trailer</h2>
        <div class="anime-video-container">
            <iframe src={{concat this.model.trailer.embed_url "?autoplay=0&rel=0" }} frameborder="0" allowfullscreen
                loading="lazy"></iframe>
        </div>
    </div>

    {{/if}}

    <div id="anime-episodes-section" class="anime-episodes-section">
        <h2>{{d-icon "film"}} {{if this.isMovie "Related Media & Discussions" "Episodes & Discussions"}}</h2>
        {{#if this.model.episodeDiscussions.length}}
        <div class="episode-discussions-list">
            {{#each this.paginatedEpisodes as |episode|}}
            <div class="episode-discussion-item {{if episode.forum_topic 'has-discussion'}}">
                <div class="episode-number">
                    <span class="number">Ep {{episode.episode_number}}</span>
                    {{#if episode.aired_at}}
                    <span class="air-date">{{format-date episode.aired_at format="medium"}}</span>
                    {{/if}}
                </div>
                <div class="episode-discussion-info">
                    <div class="episode-main-info">
                        <div class="episode-title-container">
                            {{#if episode.forum_topic}}
                            <a href={{episode.forum_topic.topic_url}} class="discussion-link">
                                {{or episode.title (concat "Episode " episode.episode_number)}}
                            </a>
                            {{else}}
                            <span class="episode-title-only">
                                {{or episode.title (concat "Episode " episode.episode_number)}}
                                {{#if (and episode.filler (not episode.recap))}}
                                <span class="badge-filler">Filler</span>
                                {{/if}}
                                {{#if episode.recap}}
                                <span class="badge-recap">Recap</span>
                                {{/if}}
                            </span>
                            {{/if}}

                            {{#if episode.title_japanese}}
                            <div class="episode-title-japanese">{{episode.title_japanese}}</div>
                            {{/if}}

                            {{#if episode.duration}}
                            <div class="episode-metadata-sub">
                                <span class="duration">{{d-icon "clock"}} {{episode.duration}}m</span>
                            </div>
                            {{/if}}
                        </div>

                        <div class="episode-actions">
                            {{#if episode.forum_topic}}
                            <span class="discussion-stats">
                                {{d-icon "comments"}} {{episode.forum_topic.post_count}} {{#if (eq
                                episode.forum_topic.post_count
                                1)}}reply{{else}}replies{{/if}}
                            </span>
                            {{else}}
                            {{#if (and this.currentUser (not (eq this.model.status "Not yet aired")))}}
                            <button type="button" class="btn btn-small btn-create-ep-discussion" {{on "click" (fn
                                this.createDiscussion "episodes" episode)}}>
                                {{d-icon "plus"}} Start Discussion
                            </button>
                            {{/if}}
                            {{/if}}
                        </div>
                    </div>

                    {{#if episode.streamingProviders}}
                    <div class="episode-streaming-sidebar {{if (gt episode.streamingProviders.length 1) "
                        multi-provider"}}">
                        {{#each episode.streamingProviders as |provider|}}
                        <a href={{provider.url}} target="_blank" rel="noopener" class="streaming-sidebar-link"
                            title="Watch on {{provider.site}} ({{provider.type}} link)">
                            <div class="streaming-provider-box">
                                <img src={{provider.faviconUrl}} alt={{provider.site}} class="provider-large-favicon" />
                                <span class="provider-label">{{provider.site}}</span>
                            </div>
                            <div class="streaming-action-hover">
                                {{d-icon "play"}}
                            </div>
                        </a>
                        {{/each}}
                    </div>
                    {{/if}}
                </div>
            </div>
            {{/each}}
        </div>

        {{#if (gt this.totalEpisodePages 1)}}
        <div class="anime-pagination">
            <button type="button" class="btn btn-default {{if (eq this.episodePage 1) 'disabled'}}" {{on "click"
                this.prevEpisodePage}} disabled={{eq this.episodePage 1}}>
                {{d-icon "chevron-left"}} Previous
            </button>
            <span class="page-info">Page {{this.episodePage}} of {{this.totalEpisodePages}}</span>
            <button type="button" class="btn btn-default {{if (eq this.episodePage this.totalEpisodePages) 'disabled'}}"
                {{on "click" this.nextEpisodePage}} disabled={{eq this.episodePage this.totalEpisodePages}}>
                Next {{d-icon "chevron-right"}}
            </button>
        </div>
        {{/if}}

        {{else}}
        <p class="no-episodes-message">
            {{d-icon "info-circle"}} No episode information available for this anime yet.
            {{#if this.currentUser}}
            Episode discussions will appear here once they are created.
            {{/if}}
        </p>
        {{/if}}
    </div>

    <div id="anime-discussion-section" class="anime-discussion-section">
        <h2>{{d-icon "comments"}} Discussions</h2>

        {{#if this.model.topics}}
        <div class="existing-topics-list">
            {{#each this.model.topics as |topic|}}
            <a href="/t/{{topic.slug}}/{{topic.id}}" class="anime-topic-item">
                <span class="topic-title">
                    {{d-icon "comment"}} {{topic.title}}
                </span>
                <span class="topic-meta">
                    {{topic.post_count}} {{d-icon "far-comment"}} â€¢ {{format-date topic.last_posted_at leaveAgo="true"}}
                </span>
            </a>
            {{/each}}
        </div>

        {{#if this.currentUser}}
        <div class="discussion-buttons compact">
            <button type="button" class="btn btn-small btn-primary" {{on "click" (fn this.createDiscussion "general"
                )}}>
                {{d-icon "plus"}} New Discussion
            </button>
        </div>
        {{/if}}
        {{else}}
        <div class="no-comments">
            <p>{{d-icon "far-comment-dots"}} No discussions yet. Be the first to share your thoughts!</p>
            {{#if this.currentUser}}
            <div class="discussion-buttons">
                <button type="button" class="btn btn-primary" {{on "click" (fn this.createDiscussion "general" )}}>
                    {{d-icon "plus"}} Start Discussion
                </button>
            </div>
            {{else}}
            <p class="login-prompt"><a href="/login">Log in</a> to start a discussion</p>
            {{/if}}
        </div>
        {{/if}}
    </div>

    {{!-- AniList Data --}}
    {{#if this.model.anilist}}

    {{!-- Characters Section --}}
    {{#if this.model.anilist.characters}}
    <div id="anime-characters-section" class="anime-characters-section">
        <h2>{{d-icon "users"}} Characters</h2>
        <div class="characters-grid">
            {{#each this.model.anilist.characters as |character|}}
            <div class="character-card">
                <img src={{character.image.large}} alt={{character.name.full}} loading="lazy" />
                <div class="character-info">
                    <h4>{{character.name.full}}</h4>
                    {{#if character.name.native}}
                    <p class="native-name">{{character.name.native}}</p>
                    {{/if}}
                </div>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- Related Anime --}}
    {{#if this.model.anilist.relations}}
    <div class="anime-relations-section">
        <h2>{{d-icon "link"}} Related Anime</h2>
        <div class="relations-grid">
            {{#each this.model.anilist.relations as |relation|}}
            <div class="relation-card">
                <div class="relation-type">{{relation.relationType}}</div>
                {{#if relation.node.coverImage.medium}}
                <img src={{relation.node.coverImage.medium}} alt={{relation.node.title.romaji}} loading="lazy" />
                {{/if}}
                <div class="relation-info">
                    <h4>{{or relation.node.title.english relation.node.title.romaji}}</h4>
                    <p class="relation-format">{{relation.node.format}}</p>
                    {{#if relation.node.idMal}}
                    <LinkTo @route="anime.show" @model={{relation.node.idMal}} class="relation-link">View Details
                    </LinkTo>
                    {{/if}}
                </div>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- External Links --}}
    {{#if this.model.anilist.external_links}}
    <div class="anime-external-section">
        <h2>{{d-icon "globe"}} External Links</h2>
        <div class="external-links">
            <a href={{this.model.anilist.url}} target="_blank" rel="noopener" class="external-link anilist">
                {{d-icon "external-link-alt"}} AniList
            </a>
            {{#each this.model.anilist.external_links as |link|}}
            <a href={{link.url}} target="_blank" rel="noopener" class="external-link">
                {{d-icon "external-link-alt"}} {{link.site}}
            </a>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{/if}}

    {{!-- TMDB Data --}}
    {{#if this.model.tmdb}}

    {{!-- Cast & Crew --}}
    {{#if this.model.tmdb.cast}}
    <div class="anime-cast-section">
        <h2>{{d-icon "user-tie"}} Cast & Crew</h2>
        <div class="cast-grid">
            {{#each this.model.tmdb.cast as |person|}}
            <div class="cast-card">
                {{#if person.profile_path}}
                <img src="https://image.tmdb.org/t/p/w185{{person.profile_path}}" alt={{person.name}} loading="lazy" />
                {{else}}
                <div class="no-photo">{{d-icon "user"}}</div>
                {{/if}}
                <div class="cast-info">
                    <h4>{{person.name}}</h4>
                    <p class="character-name">{{person.character}}</p>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- Additional Media --}}
    {{#if this.model.tmdb.videos}}
    <div class="anime-videos-section">
        <div class="section-header">
            <h2>{{d-icon "video"}} Videos & Trailers</h2>
        </div>
        <div class="videos-grid">
            {{#each this.model.tmdb.videos as |video|}}
            {{#if (eq video.site "YouTube")}}
            <div class="video-card" {{on "click" (fn this.playVideo video)}}>
                <div class="video-thumbnail">
                    <img src="https://img.youtube.com/vi/{{video.key}}/mqdefault.jpg" alt={{video.name}}
                        loading="lazy" />
                    <div class="play-overlay">{{d-icon "play"}}</div>
                </div>
                <div class="video-info">
                    <span class="video-type">{{video.type}}</span>
                    <p class="video-title">{{video.name}}</p>
                </div>
            </div>
            {{/if}}
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- Video Modal --}}
    {{#if this.activeVideo}}
    <div class="anime-video-modal" {{on "click" this.closeVideo}}>
        <div class="modal-content" {{on "click" this.stopClick}}>
            <button type="button" class="close-modal" {{on "click" this.closeVideo}}>
                {{d-icon "times"}}
            </button>
            <div class="video-wrapper">
                <iframe src="https://www.youtube-nocookie.com/embed/{{this.activeVideo.key}}?autoplay=1" frameborder="0"
                    allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
            <div class="modal-footer">
                <h3>{{this.activeVideo.name}}</h3>
                <span class="video-type">{{this.activeVideo.type}}</span>
            </div>
        </div>
    </div>
    {{/if}}

    {{!-- Alternative Posters --}}
    {{#if this.model.tmdb.posters}}
    <div class="anime-posters-section">
        <div class="section-header">
            <h2>{{d-icon "images"}} Alternative Posters</h2>
        </div>
        <div class="posters-grid">
            {{#each this.model.tmdb.posters as |poster|}}
            <div class="poster-item">
                <img src="https://image.tmdb.org/t/p/w342{{poster.file_path}}" alt="Poster" loading="lazy" />
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{/if}}

</div>

{{!-- Sticky Watchlist FAB with Menu (Mobile Only) --}}
{{#if this.currentUser}}
<div class="anime-sticky-fab {{if this.fabMenuOpen 'menu-open'}}">
    {{!-- Backdrop to close menu --}}
    {{#if this.fabMenuOpen}}
    <div class="fab-backdrop" {{on "click" this.closeFabMenu}}></div>
    {{/if}}

    {{!-- Status Menu --}}
    <div class="fab-menu {{if this.fabMenuOpen 'visible'}}">
        <button type="button"
            class="fab-menu-item plan_to_watch {{if (eq this.watchlistStatus 'plan_to_watch') 'active'}}" {{on "click"
            (fn this.setStatusFromFab "plan_to_watch" )}}>
            {{d-icon "clock"}} Plan to Watch
        </button>
        <button type="button" class="fab-menu-item watching {{if (eq this.watchlistStatus 'watching') 'active'}}"
            {{on "click" (fn this.setStatusFromFab "watching" )}}>
            {{d-icon "play"}} Watching
        </button>
        <button type="button" class="fab-menu-item completed {{if (eq this.watchlistStatus 'completed') 'active'}}"
            {{on "click" (fn this.setStatusFromFab "completed" )}}>
            {{d-icon "check"}} Completed
        </button>
        <button type="button" class="fab-menu-item on_hold {{if (eq this.watchlistStatus 'on_hold') 'active'}}"
            {{on "click" (fn this.setStatusFromFab "on_hold" )}}>
            {{d-icon "pause"}} On Hold
        </button>
        <button type="button" class="fab-menu-item dropped {{if (eq this.watchlistStatus 'dropped') 'active'}}"
            {{on "click" (fn this.setStatusFromFab "dropped" )}}>
            {{d-icon "times"}} Dropped
        </button>
    </div>

    {{!-- Main FAB Button --}}
    <button type="button" class="fab-btn {{this.watchlistStatus}}" {{on "click" this.quickAddToWatchlist}}>
        {{#if this.fabMenuOpen}}
        {{d-icon "times"}}
        {{else if this.watchlistStatus}}
        {{d-icon "check"}}
        {{else}}
        {{d-icon "plus"}}
        {{/if}}
    </button>
</div>
{{/if}}