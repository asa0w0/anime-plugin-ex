<div class="anime-detail-container">
    <div class="anime-detail-header">
        <div class="anime-detail-image">
            <img src={{or this.model.images.jpg.large_image_url
                this.model.images.jpg.image_url "/plugins/anime-plugin-ex/images/no-image.png" }} alt={{or
                this.model.title "Anime Poster" }} />
        </div>
        <div class="anime-detail-info">
            <h1>{{or this.model.title "Loading..."}}</h1>
            <div class="anime-rating">
                <span class="label">Score:</span>
                <span class="value">{{or this.model.score "N/A"}}</span>
            </div>
            <div class="anime-meta">
                <p><strong>Status:</strong> {{or this.model.status "N/A"}}</p>
                <p><strong>Episodes:</strong> {{or this.model.episodes "N/A"}}</p>
                <p><strong>Aired:</strong> {{or this.model.aired.string "N/A"}}</p>
            </div>
            <div class="anime-genres">
                {{#each this.model.genres as |genre|}}
                <span class="genre-tag">{{genre.name}}</span>
                {{/each}}
            </div>

            {{#if this.currentUser}}
            <div class="anime-watchlist-actions">
                <div class="watchlist-controls">
                    <select class="watchlist-status-select" {{on "change" this.changeStatus}}>
                        <option value="">Choose Status...</option>
                        <option value="planned" selected={{eq (or this.selectedStatus this.watchlistStatus) "planned"
                            }}>Plan to Watch</option>
                        <option value="watching" selected={{eq (or this.selectedStatus this.watchlistStatus) "watching"
                            }}>Watching</option>
                        <option value="completed" selected={{eq (or this.selectedStatus
                            this.watchlistStatus) "completed" }}>Completed</option>
                    </select>

                    <button type="button" class="btn btn-primary" {{on "click" this.saveToWatchlist}} disabled={{not (or
                        this.selectedStatus this.watchlistStatus)}}>
                        {{#if this.watchlistStatus}}
                        Update
                        {{else}}
                        Add to Watchlist
                        {{/if}}
                    </button>
                </div>

                {{#if this.watchlistStatus}}
                <div class="current-status-info">
                    <span class="label">Current Status:</span>
                    <span class="current-status-badge {{this.watchlistStatus}}">
                        {{this.displayWatchlistStatus}}
                    </span>
                </div>
                {{/if}}
            </div>
            {{/if}}
        </div>
    </div>

    <div class="anime-synopsis">
        <h2>Synopsis</h2>
        <p>{{this.model.synopsis}}</p>
    </div>

    {{#if this.model.trailer.embed_url}}
    <div class="anime-trailer">
        <h2>Trailer</h2>
        <div class="anime-video-container">
            <iframe src={{this.model.trailer.embed_url}} frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
    {{/if}}

    {{#if this.model.episodeDiscussions.length}}
    <div class="anime-episodes-section">
        <h2>{{d-icon "film"}} Episodes & Discussions</h2>
        <div class="episode-discussions-list">
            {{#each this.model.episodeDiscussions as |episode|}}
            <div class="episode-discussion-item {{if episode.forum_topic 'has-discussion'}}">
                <div class="episode-number">
                    <span class="number">Ep {{episode.episode_number}}</span>
                    {{#if episode.aired_at}}
                    <span class="air-date">{{format-date episode.aired_at format="medium"}}</span>
                    {{/if}}
                </div>
                <div class="episode-discussion-info">
                    <div class="episode-main-info">
                        {{#if episode.forum_topic}}
                        <a href={{episode.forum_topic.topic_url}} class="discussion-link">
                            {{d-icon "comments"}} {{or episode.title (concat "Episode " episode.episode_number)}}
                        </a>
                        {{else}}
                        <span class="episode-title-only">
                            {{or episode.title (concat "Episode " episode.episode_number)}}
                            {{#if (and episode.filler (not episode.recap))}}
                            <span class="badge-filler">Filler</span>
                            {{/if}}
                            {{#if episode.recap}}
                            <span class="badge-recap">Recap</span>
                            {{/if}}
                        </span>
                        {{/if}}
                    </div>

                    {{#if episode.forum_topic}}
                    <span class="discussion-stats">
                        {{episode.forum_topic.post_count}} {{#if (eq episode.forum_topic.post_count
                        1)}}reply{{else}}replies{{/if}}
                    </span>
                    {{else}}
                    {{#if (and this.currentUser (not (eq this.model.status "Not yet aired")))}}
                    <button type="button" class="btn btn-small btn-create-ep-discussion" {{on "click" (fn
                        this.createDiscussion "episodes" episode)}}>
                        {{d-icon "plus"}} Start Discussion
                    </button>
                    {{/if}}
                    {{/if}}
                </div>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    <div class="anime-discussion-section">
        <h2>{{d-icon "comments"}} Discussions</h2>

        {{#if this.model.topics}}
        <div class="existing-topics-list">
            {{#each this.model.topics as |topic|}}
            <a href="/t/{{topic.slug}}/{{topic.id}}" class="anime-topic-item">
                <span class="topic-title">
                    {{d-icon "comment"}} {{topic.title}}
                </span>
                <span class="topic-meta">
                    {{topic.post_count}} {{d-icon "far-comment"}} â€¢ {{format-date topic.last_posted_at leaveAgo="true"}}
                </span>
            </a>
            {{/each}}
        </div>

        {{#if this.currentUser}}
        <div class="discussion-buttons compact">
            <button type="button" class="btn btn-small" {{on "click" (fn this.createDiscussion "general" )}}>
                {{d-icon "plus"}} New Discussion
            </button>
            <button type="button" class="btn btn-small" {{on "click" (fn this.createDiscussion "episodes" )}}>
                {{d-icon "film"}} Episode Discussion
            </button>
        </div>
        {{/if}}
        {{else}}
        <div class="no-comments">
            <p>{{d-icon "far-comment-dots"}} No discussions yet. Be the first to share your thoughts!</p>
            {{#if this.currentUser}}
            <div class="discussion-buttons">
                <button type="button" class="btn btn-primary" {{on "click" (fn this.createDiscussion "general" )}}>
                    {{d-icon "plus"}} Start Discussion
                </button>
                <button type="button" class="btn btn-default" {{on "click" (fn this.createDiscussion "episodes" )}}>
                    {{d-icon "plus"}} Episode Discussion
                </button>
            </div>
            {{else}}
            <p class="login-prompt"><a href="/login">Log in</a> to start a discussion</p>
            {{/if}}
        </div>
        {{/if}}
    </div>
</div>