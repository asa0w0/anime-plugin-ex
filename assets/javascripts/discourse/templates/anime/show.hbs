<div class="anime-detail-container">
    <div class="anime-detail-header">
        <div class="anime-detail-image">
            <img src={{or this.model.images.jpg.large_image_url
                this.model.images.jpg.image_url "/plugins/anime-plugin-ex/images/no-image.png" }} alt={{or
                this.model.title "Anime Poster" }} />
        </div>
        <div class="anime-detail-info">
            <h1>{{or this.model.title "Loading..."}}</h1>
            <div class="anime-rating">
                <span class="label">Score:</span>
                <span class="value">{{or this.model.score "N/A"}}</span>
            </div>
            <div class="anime-meta">
                <p><strong>Status:</strong> {{or this.model.status "N/A"}}</p>
                <p><strong>Episodes:</strong> {{or this.model.episodes "N/A"}}</p>
                <p><strong>Aired:</strong> {{or this.model.aired.string "N/A"}}</p>
            </div>
            <div class="anime-genres">
                {{#each this.model.genres as |genre|}}
                <span class="genre-tag">{{genre.name}}</span>
                {{/each}}
            </div>

            {{#if this.currentUser}}
            <div class="anime-watchlist-actions">
                <div class="watchlist-controls">
                    <select class="watchlist-status-select" {{on "change" this.changeStatus}}>
                        <option value="">Choose Status...</option>
                        <option value="planned" selected={{eq (or this.selectedStatus this.watchlistStatus) "planned"
                            }}>Plan to Watch</option>
                        <option value="watching" selected={{eq (or this.selectedStatus this.watchlistStatus) "watching"
                            }}>Watching</option>
                        <option value="completed" selected={{eq (or this.selectedStatus
                            this.watchlistStatus) "completed" }}>Completed</option>
                    </select>

                    <button type="button" class="btn btn-primary" {{on "click" this.saveToWatchlist}} disabled={{not (or
                        this.selectedStatus this.watchlistStatus)}}>
                        {{#if this.watchlistStatus}}
                        Update
                        {{else}}
                        Add to Watchlist
                        {{/if}}
                    </button>
                </div>

                {{#if this.watchlistStatus}}
                <div class="current-status-info">
                    <span class="label">Current Status:</span>
                    <span class="current-status-badge {{this.watchlistStatus}}">
                        {{this.displayWatchlistStatus}}
                    </span>
                </div>
                {{/if}}
            </div>
            {{/if}}
        </div>
    </div>

    <div class="anime-synopsis">
        <h2>Synopsis</h2>
        <p>{{this.model.synopsis}}</p>
    </div>

    {{#if this.model.trailer.embed_url}}
    {{#if (or (includes this.model.trailer.embed_url "youtube.com") (includes this.model.trailer.embed_url
    "youtube-nocookie.com"))}}
    <div class="anime-trailer">
        <h2>Trailer</h2>
        <div class="anime-video-container">
            <iframe src={{this.model.trailer.embed_url}} frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
    {{/if}}
    {{/if}}

    <div class="anime-episodes-section">
        <h2>{{d-icon "film"}} Episodes & Discussions</h2>
        {{#if this.model.episodeDiscussions.length}}
        <div class="episode-discussions-list">
            {{#each this.paginatedEpisodes as |episode|}}
            <div class="episode-discussion-item {{if episode.forum_topic 'has-discussion'}}">
                <div class="episode-number">
                    <span class="number">Ep {{episode.episode_number}}</span>
                    {{#if episode.aired_at}}
                    <span class="air-date">{{format-date episode.aired_at format="medium"}}</span>
                    {{/if}}
                </div>
                <div class="episode-discussion-info">
                    <div class="episode-main-info">
                        {{#if episode.forum_topic}}
                        <a href={{episode.forum_topic.topic_url}} class="discussion-link">
                            {{d-icon "comments"}} {{or episode.title (concat "Episode " episode.episode_number)}}
                        </a>
                        {{else}}
                        <span class="episode-title-only">
                            {{or episode.title (concat "Episode " episode.episode_number)}}
                            {{#if (and episode.filler (not episode.recap))}}
                            <span class="badge-filler">Filler</span>
                            {{/if}}
                            {{#if episode.recap}}
                            <span class="badge-recap">Recap</span>
                            {{/if}}
                        </span>
                        {{/if}}
                    </div>

                    <div class="episode-actions">
                        {{#if episode.streaming}}
                        <a href={{episode.streaming.url}} target="_blank" rel="noopener"
                            class="btn btn-small btn-streaming" title="Watch on {{episode.streaming.site}}">
                            <img src={{episode.streaming.faviconUrl}} alt={{episode.streaming.site}}
                                class="provider-favicon" />
                            <span class="provider-name">{{episode.streaming.site}}</span>
                        </a>
                        {{/if}}

                        {{#if episode.forum_topic}}
                        <span class="discussion-stats">
                            {{episode.forum_topic.post_count}} {{#if (eq episode.forum_topic.post_count
                            1)}}reply{{else}}replies{{/if}}
                        </span>
                        {{else}}
                        {{#if (and this.currentUser (not (eq this.model.status "Not yet aired")))}}
                        <button type="button" class="btn btn-small btn-create-ep-discussion" {{on "click" (fn
                            this.createDiscussion "episodes" episode)}}>
                            {{d-icon "plus"}} Start Discussion
                        </button>
                        {{/if}}
                        {{/if}}
                    </div>
                </div>
            </div>
            {{/each}}
        </div>

        {{#if (gt this.totalEpisodePages 1)}}
        <div class="anime-pagination">
            <button type="button" class="btn btn-default {{if (eq this.episodePage 1) 'disabled'}}" {{on "click"
                this.prevEpisodePage}} disabled={{eq this.episodePage 1}}>
                {{d-icon "chevron-left"}} Previous
            </button>
            <span class="page-info">Page {{this.episodePage}} of {{this.totalEpisodePages}}</span>
            <button type="button" class="btn btn-default {{if (eq this.episodePage this.totalEpisodePages) 'disabled'}}"
                {{on "click" this.nextEpisodePage}} disabled={{eq this.episodePage this.totalEpisodePages}}>
                Next {{d-icon "chevron-right"}}
            </button>
        </div>
        {{/if}}

        {{else}}
        <p class="no-episodes-message">
            {{d-icon "info-circle"}} No episode information available for this anime yet.
            {{#if this.currentUser}}
            Episode discussions will appear here once they are created.
            {{/if}}
        </p>
        {{/if}}
    </div>

    <div class="anime-discussion-section">
        <h2>{{d-icon "comments"}} Discussions</h2>

        {{#if this.model.topics}}
        <div class="existing-topics-list">
            {{#each this.model.topics as |topic|}}
            <a href="/t/{{topic.slug}}/{{topic.id}}" class="anime-topic-item">
                <span class="topic-title">
                    {{d-icon "comment"}} {{topic.title}}
                </span>
                <span class="topic-meta">
                    {{topic.post_count}} {{d-icon "far-comment"}} â€¢ {{format-date topic.last_posted_at leaveAgo="true"}}
                </span>
            </a>
            {{/each}}
        </div>

        {{#if this.currentUser}}
        <div class="discussion-buttons compact">
            <button type="button" class="btn btn-small btn-primary" {{on "click" (fn this.createDiscussion "general"
                )}}>
                {{d-icon "plus"}} New Discussion
            </button>
        </div>
        {{/if}}
        {{else}}
        <div class="no-comments">
            <p>{{d-icon "far-comment-dots"}} No discussions yet. Be the first to share your thoughts!</p>
            {{#if this.currentUser}}
            <div class="discussion-buttons">
                <button type="button" class="btn btn-primary" {{on "click" (fn this.createDiscussion "general" )}}>
                    {{d-icon "plus"}} Start Discussion
                </button>
            </div>
            {{else}}
            <p class="login-prompt"><a href="/login">Log in</a> to start a discussion</p>
            {{/if}}
        </div>
        {{/if}}
    </div>

    {{!-- AniList Data --}}
    {{#if this.model.anilist}}

    {{!-- Characters Section --}}
    {{#if this.model.anilist.characters}}
    <div class="anime-characters-section">
        <h2>{{d-icon "users"}} Characters</h2>
        <div class="characters-grid">
            {{#each this.model.anilist.characters as |character|}}
            <div class="character-card">
                <img src={{character.image.large}} alt={{character.name.full}} loading="lazy" />
                <div class="character-info">
                    <h4>{{character.name.full}}</h4>
                    {{#if character.name.native}}
                    <p class="native-name">{{character.name.native}}</p>
                    {{/if}}
                </div>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- Related Anime --}}
    {{#if this.model.anilist.relations}}
    <div class="anime-relations-section">
        <h2>{{d-icon "link"}} Related Anime</h2>
        <div class="relations-grid">
            {{#each this.model.anilist.relations as |relation|}}
            <div class="relation-card">
                <div class="relation-type">{{relation.relationType}}</div>
                {{#if relation.node.coverImage.medium}}
                <img src={{relation.node.coverImage.medium}} alt={{relation.node.title.romaji}} loading="lazy" />
                {{/if}}
                <div class="relation-info">
                    <h4>{{or relation.node.title.english relation.node.title.romaji}}</h4>
                    <p class="relation-format">{{relation.node.format}}</p>
                    {{#if relation.node.idMal}}
                    <LinkTo @route="anime.show" @model={{relation.node.idMal}} class="relation-link">View Details
                    </LinkTo>
                    {{/if}}
                </div>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- External Links --}}
    {{#if this.model.anilist.external_links}}
    <div class="anime-external-section">
        <h2>{{d-icon "globe"}} External Links</h2>
        <div class="external-links">
            <a href={{this.model.anilist.url}} target="_blank" rel="noopener" class="external-link anilist">
                {{d-icon "external-link-alt"}} AniList
            </a>
            {{#each this.model.anilist.external_links as |link|}}
            <a href={{link.url}} target="_blank" rel="noopener" class="external-link">
                {{d-icon "external-link-alt"}} {{link.site}}
            </a>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{/if}}

    {{!-- TMDB Data --}}
    {{#if this.model.tmdb}}

    {{!-- Cast & Crew --}}
    {{#if this.model.tmdb.cast}}
    <div class="anime-cast-section">
        <h2>{{d-icon "user-tie"}} Cast & Crew</h2>
        <div class="cast-grid">
            {{#each this.model.tmdb.cast as |person|}}
            <div class="cast-card">
                {{#if person.profile_path}}
                <img src="https://image.tmdb.org/t/p/w185{{person.profile_path}}" alt={{person.name}} loading="lazy" />
                {{else}}
                <div class="no-photo">{{d-icon "user"}}</div>
                {{/if}}
                <div class="cast-info">
                    <h4>{{person.name}}</h4>
                    <p class="character-name">{{person.character}}</p>
                </div>
            </div>
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- Additional Media --}}
    {{#if this.model.tmdb.videos}}
    <div class="anime-videos-section">
        <h2>{{d-icon "video"}} Videos & Trailers</h2>
        <div class="videos-grid">
            {{#each this.model.tmdb.videos as |video|}}
            {{#if (eq video.site "YouTube")}}
            <div class="video-card">
                <iframe src="https://www.youtube-nocookie.com/embed/{{video.key}}" frameborder="0" allowfullscreen
                    loading="lazy"></iframe>
                <p class="video-title">{{video.name}}</p>
            </div>
            {{/if}}
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{!-- Alternative Posters --}}
    {{#if this.model.tmdb.posters}}
    <div class="anime-posters-section">
        <h2>{{d-icon "images"}} Alternative Posters</h2>
        <div class="posters-grid">
            {{#each this.model.tmdb.posters as |poster|}}
            <img src="https://image.tmdb.org/t/p/w342{{poster.file_path}}" alt="Poster" loading="lazy" />
            {{/each}}
        </div>
    </div>
    {{/if}}

    {{/if}}

</div>