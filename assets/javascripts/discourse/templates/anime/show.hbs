<div class="anime-detail-container">
    <div class="anime-detail-header">
        <div class="anime-detail-image">
            <img src={{this.model.images.jpg.large_image_url}} alt={{this.model.title}} />
        </div>
        <div class="anime-detail-info">
            <h1>{{this.model.title}}</h1>
            <div class="anime-rating">
                <span class="label">Score:</span>
                <span class="value">{{this.model.score}}</span>
            </div>
            <div class="anime-meta">
                <p><strong>Status:</strong> {{this.model.status}}</p>
                <p><strong>Episodes:</strong> {{this.model.episodes}}</p>
                <p><strong>Aired:</strong> {{this.model.aired.string}}</p>
            </div>
            <div class="anime-genres">
                {{#each this.model.genres as |genre|}}
                <span class="genre-tag">{{genre.name}}</span>
                {{/each}}
            </div>

            {{#if this.currentUser}}
            <div class="anime-watchlist-actions">
                <div class="watchlist-controls">
                    <select class="watchlist-status-select" {{on "change" this.changeStatus}}>
                        <option value="">Choose Status...</option>
                        <option value="planned" selected={{eq (or this.selectedStatus this.watchlistStatus) "planned"
                            }}>Plan to Watch</option>
                        <option value="watching" selected={{eq (or this.selectedStatus this.watchlistStatus) "watching"
                            }}>Watching</option>
                        <option value="completed" selected={{eq (or this.selectedStatus
                            this.watchlistStatus) "completed" }}>Completed</option>
                    </select>

                    <button type="button" class="btn btn-primary" {{on "click" this.saveToWatchlist}} disabled={{not (or
                        this.selectedStatus this.watchlistStatus)}}>
                        {{#if this.watchlistStatus}}
                        Update
                        {{else}}
                        Add to Watchlist
                        {{/if}}
                    </button>
                </div>

                {{#if this.watchlistStatus}}
                <div class="current-status-info">
                    <span class="label">Current Status:</span>
                    <span class="current-status-badge {{this.watchlistStatus}}">
                        {{this.displayWatchlistStatus}}
                    </span>
                </div>
                {{/if}}
            </div>
            {{/if}}
        </div>
    </div>

    <div class="anime-synopsis">
        <h2>Synopsis</h2>
        <p>{{this.model.synopsis}}</p>
    </div>

    {{#if this.model.trailer.embed_url}}
    <div class="anime-trailer">
        <h2>Trailer</h2>
        <div class="anime-video-container">
            <iframe src={{this.model.trailer.embed_url}} frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
    {{/if}}

    <div class="anime-discussion-section">
        <div class="discussion-header">
            <h2>Community Discussions</h2>
            {{#if this.currentUser}}
            <button type="button" class="btn btn-primary" {{on "click" (fn this.createDiscussion "general" )}}>
                {{d-icon "plus"}} Start General Discussion
            </button>
            {{/if}}
        </div>

        <div class="discussion-grid-layout">
            <div class="general-discussions">
                <h3>General Chat</h3>
                {{#if this.generalTopics}}
                <div class="topic-list">
                    {{#each this.generalTopics as |topic|}}
                    <div class="anime-topic-item">
                        <a href="/t/{{topic.slug}}/{{topic.id}}" class="topic-title">
                            {{d-icon "comments"}} {{topic.title}}
                        </a>
                        <span class="topic-meta">
                            {{topic.post_count}} posts â€¢ {{format-date topic.last_posted_at}}
                        </span>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <p class="no-topics-msg">No general discussions yet.</p>
                {{/if}}
            </div>

            <div class="episode-discussions">
                <h3>Episode Discussions</h3>
                <div class="episode-selector-grid">
                    {{#each this.episodeList as |ep|}}
                    <button type="button" class="episode-btn {{if (find-by this.episodeTopics " episode_number" (concat
                        ep)) "has-discussion" }}" {{on "click" (fn this.createDiscussion "episodes" ep)}}>
                        {{ep}}
                    </button>
                    {{/each}}
                </div>

                {{#if this.episodeTopics}}
                <div class="topic-list episode-topic-list">
                    <h4>Latest Episode Threads</h4>
                    {{#each this.episodeTopics as |topic|}}
                    <div class="anime-topic-item mini">
                        <a href="/t/{{topic.slug}}/{{topic.id}}" class="topic-title">
                            <span class="ep-tag">Ep {{topic.episode_number}}</span> {{topic.title}}
                        </a>
                    </div>
                    {{/each}}
                </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>