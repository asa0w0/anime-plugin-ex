<div class="anime-detail-container">
    <div class="anime-detail-header">
        <div class="anime-detail-image">
            <img src={{this.model.images.jpg.large_image_url}} alt={{this.model.title}} />
        </div>
        <div class="anime-detail-info">
            <h1>{{this.model.title}}</h1>
            <div class="anime-rating">
                <span class="label">Score:</span>
                <span class="value">{{this.model.score}}</span>
            </div>
            <div class="anime-meta">
                <p><strong>Status:</strong> {{this.model.status}}</p>
                <p><strong>Episodes:</strong> {{this.model.episodes}}</p>
                <p><strong>Aired:</strong> {{this.model.aired.string}}</p>
            </div>
            <div class="anime-genres">
                {{#each this.model.genres as |genre|}}
                <span class="genre-tag">{{genre.name}}</span>
                {{/each}}
            </div>

            {{#if this.currentUser}}
            <div class="anime-watchlist-actions">
                <div class="watchlist-controls">
                    <select class="watchlist-status-select" {{on "change" this.changeStatus}}>
                        <option value="">Choose Status...</option>
                        <option value="planned" selected={{eq (or this.selectedStatus this.watchlistStatus) "planned"
                            }}>Plan to Watch</option>
                        <option value="watching" selected={{eq (or this.selectedStatus this.watchlistStatus) "watching"
                            }}>Watching</option>
                        <option value="completed" selected={{eq (or this.selectedStatus
                            this.watchlistStatus) "completed" }}>Completed</option>
                    </select>

                    <button type="button" class="btn btn-primary" {{on "click" this.saveToWatchlist}} disabled={{not (or
                        this.selectedStatus this.watchlistStatus)}}>
                        {{#if this.watchlistStatus}}
                        Update
                        {{else}}
                        Add to Watchlist
                        {{/if}}
                    </button>
                </div>

                {{#if this.watchlistStatus}}
                <div class="current-status-info">
                    <span class="label">Current Status:</span>
                    <span class="current-status-badge {{this.watchlistStatus}}">
                        {{this.displayWatchlistStatus}}
                    </span>
                </div>
                {{/if}}
            </div>
            {{/if}}
        </div>
    </div>

    <div class="anime-synopsis">
        <h2>Synopsis</h2>
        <p>{{this.model.synopsis}}</p>
    </div>

    {{#if this.model.trailer.embed_url}}
    <div class="anime-trailer">
        <h2>Trailer</h2>
        <div class="anime-video-container">
            <iframe src={{this.model.trailer.embed_url}} frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
    {{/if}}

    {{#if (or this.model.episodeDiscussions.length (eq this.model.status "Currently Airing"))}}
    <div class="anime-episodes-section">
        <h2>{{d-icon "film"}} Episodes & Discussions</h2>

        {{#if this.model.episodeDiscussions.length}}
        <div class="episode-discussions-list">
            {{#each this.model.episodeDiscussions as |episode|}}
            <div class="episode-discussion-item">
                <div class="episode-number">
                    <span class="number">Ep {{episode.episode_number}}</span>
                    {{#if episode.aired_at}}
                    <span class="air-date">{{format-date episode.aired_at format="medium"}}</span>
                    {{/if}}
                </div>
                <div class="episode-discussion-info">
                    <a href={{episode.topic_url}} class="discussion-link">
                        {{d-icon "comments"}} {{episode.topic_title}}
                    </a>
                    <span class="discussion-stats">
                        {{episode.post_count}} {{#if (eq episode.post_count 1)}}reply{{else}}replies{{/if}}
                    </span>
                </div>
            </div>
            {{/each}}
        </div>
        {{else}}
        <div class="no-episodes-yet">
            <p>{{d-icon "clock"}} No episode discussions yet.</p>
            {{#if (eq this.model.status "Currently Airing")}}
            <p class="info-text">Episode discussions will be created automatically when new episodes air.</p>
            {{/if}}
        </div>
        {{/if}}
    </div>
    {{/if}}

    <div class="anime-discussion-section">
        <h2>{{d-icon "comments"}} Discussions</h2>

        {{#if this.model.topics}}
        <div class="existing-topics-list">
            {{#each this.model.topics as |topic|}}
            <a href="/t/{{topic.slug}}/{{topic.id}}" class="anime-topic-item">
                <span class="topic-title">
                    {{d-icon "comment"}} {{topic.title}}
                </span>
                <span class="topic-meta">
                    {{topic.post_count}} {{d-icon "far-comment"}} â€¢ {{format-date topic.last_posted_at leaveAgo="true"}}
                </span>
            </a>
            {{/each}}
        </div>

        {{#if this.currentUser}}
        <div class="discussion-buttons compact">
            <button type="button" class="btn btn-small" {{on "click" (fn this.createDiscussion "general" )}}>
                {{d-icon "plus"}} New Discussion
            </button>
            <button type="button" class="btn btn-small" {{on "click" (fn this.createDiscussion "episodes" )}}>
                {{d-icon "film"}} Episode Discussion
            </button>
        </div>
        {{/if}}
        {{else}}
        <div class="no-comments">
            <p>{{d-icon "far-comment-dots"}} No discussions yet. Be the first to share your thoughts!</p>
            {{#if this.currentUser}}
            <div class="discussion-buttons">
                <button type="button" class="btn btn-primary" {{on "click" (fn this.createDiscussion "general" )}}>
                    {{d-icon "plus"}} Start Discussion
                </button>
                <button type="button" class="btn btn-default" {{on "click" (fn this.createDiscussion "episodes" )}}>
                    {{d-icon "plus"}} Episode Discussion
                </button>
            </div>
            {{else}}
            <p class="login-prompt"><a href="/login">Log in</a> to start a discussion</p>
            {{/if}}
        </div>
        {{/if}}
    </div>
</div>