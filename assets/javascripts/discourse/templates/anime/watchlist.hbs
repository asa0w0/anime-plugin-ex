<div class="anime-watchlist-container modern-style">
    <div class="watchlist-header">
        <h1>My Anime Watchlist</h1>
        <div class="nav-tab-search">
            {{d-icon "magnifying-glass"}}
            <input type="text" placeholder="Search anime..." value={{this.searchTerm}} {{on "input"
                this.setSearchTerm}} />
            {{#if this.searchTerm}}
            <button type="button" class="btn-clear-search" {{on "click" this.clearSearch}}>{{d-icon "times"}}</button>
            {{/if}}
        </div>
    </div>

    {{#if this.model.length}}
    <div class="watchlist-controls-top">
        <ul class="nav nav-pills">
            <li class="nav-item">
                <button type="button" class="nav-link {{if (eq this.activeFilter 'all') 'active'}}" {{on "click" (fn
                    this.setActiveFilter 'all' )}}>All</button>
            </li>
            <li class="nav-item">
                <button type="button" class="nav-link {{if (eq this.activeFilter 'watching') 'active'}}" {{on "click"
                    (fn this.setActiveFilter 'watching' )}}>Watching</button>
            </li>
            <li class="nav-item">
                <button type="button" class="nav-link {{if (eq this.activeFilter 'completed') 'active'}}" {{on "click"
                    (fn this.setActiveFilter 'completed' )}}>Completed</button>
            </li>
            <li class="nav-item">
                <button type="button" class="nav-link {{if (eq this.activeFilter 'plan_to_watch') 'active'}}"
                    {{on "click" (fn this.setActiveFilter 'plan_to_watch' )}}>Plan to Watch</button>
            </li>
            <li class="nav-item">
                <button type="button" class="nav-link {{if (eq this.activeFilter 'on_hold') 'active'}}" {{on "click" (fn
                    this.setActiveFilter 'on_hold' )}}>On Hold</button>
            </li>
            <li class="nav-item">
                <button type="button" class="nav-link {{if (eq this.activeFilter 'dropped') 'active'}}" {{on "click" (fn
                    this.setActiveFilter 'dropped' )}}>Dropped</button>
            </li>
        </ul>

        {{#if this.editMode}}
        <div class="watchlist-bulk-actions">
            <button type="button" class="btn btn-default" {{on "click" this.toggleSelectAll}}>
                {{#if this.isAllSelected}}Deselect All{{else}}Select All{{/if}}
            </button>
            <button type="button" class="btn btn-danger" {{on "click" this.bulkDelete}} disabled={{not
                this.selectedIds.size}}>
                {{d-icon "trash-can"}} ({{this.selectedIds.size}})
            </button>
            <button type="button" class="btn btn-default" {{on "click" this.toggleEditMode}}>Cancel</button>
        </div>
        {{else}}
        <button type="button" class="btn btn-flat edit-mode-toggle" {{on "click" this.toggleEditMode}}
            title="Bulk Edit">
            {{d-icon "list-check"}}
        </button>
        {{/if}}
    </div>

    {{#if this.filteredModel.length}}
    <div class="watchlist-cards-grid">
        {{#each this.sortedFilteredModel as |item|}}
        <div class="watchlist-card status-{{item.status}} {{if item.selected 'selected'}}"
            data-anime-id={{item.anime_id}}>
            {{#if this.editMode}}
            <div class="card-selection-overlay" {{on "click" (fn this.toggleSelection item.anime_id)}}>
                {{d-icon (if item.selected "check-circle" "circle")}}
            </div>
            {{/if}}

            <div class="card-image">
                <LinkTo @route="anime.show" @model={{or item.slug item.anime_id}}>
                    <img src={{item.image_url}} alt={{item.title}} loading="lazy" />
                </LinkTo>
                <div class="card-type-badge">{{or item.type "TV"}}</div>
            </div>

            <div class="card-content">
                <div class="card-header">
                    <LinkTo @route="anime.show" @model={{or item.slug item.anime_id}} class="anime-title">{{item.title}}
                    </LinkTo>
                    <div class="card-status-pill {{item.status}}">{{item.formatted_status}}</div>
                </div>

                <div class="card-meta">
                    {{#if item.score}}
                    <div class="meta-item score">
                        {{d-icon "star"}} <span>{{item.score}}</span>
                    </div>
                    {{/if}}
                    <div class="meta-item progress-text">
                        {{d-icon "play"}} <span>{{or item.episodes_watched 0}} / {{or item.total_episodes '?'}}</span>
                    </div>
                </div>

                <div class="card-progress-container">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style={{html-safe (concat "width: " (or item.progress_percentage
                            0) "%" )}}></div>
                    </div>
                    <button type="button" class="btn-increment" {{on "click" (fn this.incrementProgress item.anime_id)}}
                        title="Increment Progress">
                        {{d-icon "plus"}}
                    </button>
                </div>
            </div>

            <div class="card-actions">
                <div class="status-dropdown">
                    <button type="button" class="btn-flat" data-anime-id={{item.anime_id}} {{on "click"
                        this.handleStatusToggle}} title="Change Status">
                        {{d-icon "ellipsis-v"}}
                    </button>
                    {{#if (eq this.openDropdownId item.anime_id)}}
                    <div class="status-dropdown-menu open">
                        <button type="button" data-anime-id={{item.anime_id}} data-status="watching" {{on "click"
                            this.handleStatusChange}}>{{d-icon "circle-play"}} Watching</button>
                        <button type="button" data-anime-id={{item.anime_id}} data-status="completed" {{on "click"
                            this.handleStatusChange}}>{{d-icon "circle-check"}} Completed</button>
                        <button type="button" data-anime-id={{item.anime_id}} data-status="plan_to_watch" {{on "click"
                            this.handleStatusChange}}>{{d-icon "clock"}} Plan to Watch</button>
                        <button type="button" data-anime-id={{item.anime_id}} data-status="on_hold" {{on "click"
                            this.handleStatusChange}}>{{d-icon "circle-pause"}} On Hold</button>
                        <button type="button" data-anime-id={{item.anime_id}} data-status="dropped" {{on "click"
                            this.handleStatusChange}}>{{d-icon "trash-can"}} Dropped</button>
                        <div class="dropdown-divider"></div>
                        <button type="button" class="btn-delete" data-anime-id={{item.anime_id}} {{on "click"
                            this.handleDelete}}>{{d-icon "trash-can"}} Remove</button>
                    </div>
                    {{/if}}
                </div>
            </div>
        </div>
        {{/each}}
    </div>
    {{else}}
    <div class="watchlist-empty-category">
        <div class="empty-icon">{{d-icon "magnifying-glass"}}</div>
        <p>No anime found in this category.</p>
    </div>
    {{/if}}

    {{else}}
    <div class="watchlist-empty-state">
        <div class="empty-icon">{{d-icon "list"}}</div>
        <h2>Your watchlist is empty</h2>
        <p>Start adding anime to track your progress!</p>
        <a href="/anime" class="btn btn-primary">Browse Anime</a>
    </div>
    {{/if}}
</div>